<div class="jobs-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Jobs</mat-card-title>
      <mat-card-subtitle>Active Jobs in Cluster</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Filter -->
      <mat-form-field appearance="standard" class="search-field">
        <mat-label>Filter Jobs...</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Search by name, status, etc." #input>
      </mat-form-field>

      <div class="table-container mat-elevation-z8">
        <div class="loading-shade" *ngIf="isLoadingResults || dataSource.data.length === 0">
          <mat-spinner *ngIf="isLoadingResults"></mat-spinner>
          <div class="no-results" *ngIf="!isLoadingResults">No jobs found</div>
        </div>

        <table mat-table [dataSource]="dataSource" matSort multiTemplateDataRows class="jobs-table">

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
            <td mat-cell *matCellDef="let element"> {{element.name}} </td>
          </ng-container>

          <!-- Namespace Column -->
          <ng-container matColumnDef="namespace">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Namespace </th>
            <td mat-cell *matCellDef="let element"> {{element.namespace}} </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
            <td mat-cell *matCellDef="let element">
              <span class="status-chip" [ngClass]="element.status.toLowerCase()">
                {{element.status}}
              </span>
            </td>
          </ng-container>

          <!-- Queue Column -->
          <ng-container matColumnDef="queue">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Queue </th>
            <td mat-cell *matCellDef="let element"> {{element.queue}} </td>
          </ng-container>

          <!-- Create Time Column -->
          <ng-container matColumnDef="createTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Created </th>
            <td mat-cell *matCellDef="let element"> {{element.createTime | date:'short'}} </td>
          </ng-container>

          <!-- Task Count Column -->
          <ng-container matColumnDef="tasks">
            <th mat-header-cell *matHeaderCellDef> Tasks </th>
            <td mat-cell *matCellDef="let element"> {{element.tasks?.length || 0}} </td>
          </ng-container>

          <!-- Task Detail Row (Expandable) -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
              <div class="example-element-detail"
                [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                <div class="job-detail-panel">
                  <div class="detail-header">Task Allocation for {{element.name}}</div>
                  <div *ngIf="!element.tasks || element.tasks.length === 0" class="no-tasks">
                    No tasks found.
                  </div>
                  <div class="task-grid" *ngIf="element.tasks && element.tasks.length > 0">
                    <div class="task-card" *ngFor="let task of element.tasks">
                      <div class="task-name">{{task.name}}</div>
                      <div class="task-status" [ngClass]="task.status.toLowerCase()">{{task.status}}</div>
                      <div class="task-node" *ngIf="task.nodeName">
                        <mat-icon>dns</mat-icon> {{task.nodeName}}
                      </div>
                      <div class="task-pending" *ngIf="!task.nodeName">
                        <span class="pending-label">Pending</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Header & Row Defs -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let element; columns: displayedColumns;" class="example-element-row"
            [class.example-expanded-row]="expandedElement === element"
            (click)="expandedElement = expandedElement === element ? null : element">
          </tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
        </table>

        <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons aria-label="Select page of jobs">
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>