# Proportion Plugin (资源公平分配) 走读

本文梳理 KAI Scheduler 的核心插件 **Proportion**。它是实现多租户资源隔离、配额保障（Quota）和公平共享（Fair Share）的大脑。

## 1. 核心职责

`Proportion` 插件主要负责两件事：

1. **全局账本 (Accounting)**: 计算每个队列（Queue）在当前集群状态下，“理应”分得多少资源（Fair Share, Deserved）。
2. **队列排序 (Sorting)**: 告诉调度器，在 Job 调度时，哪个队列的 Job 应该先被考虑。

这是一个 **Queue Order** 类型的插件，但也深度参与 **Reclaim/Preempt** 决策。

---

## 2. 资源计算模型 (Resource Division)

代码位置：`pkg/scheduler/plugins/proportion/resource_division/resource_division.go`

在每个调度周期开始时 (`OnSessionOpen`)，插件会快照当前集群所有节点资源，并根据队列配置计算分配方案。

### 2.1 资源分类

对于每个队列，计算以下三个关键值：

- **Deserved (Quota)**: 队列的保障资源量（Min）。
- **Request**: 队列当前所有 Job 的请求总量。
- **FairShare**: 经过算法计算后，当前周期该队列**实际可使用**的资源上限。

### 2.2 分配算法流程

1. **First Pass - 保障 Quota**:
   - 优先满足所有队列的 `Deserved` (即 `min(Quota, Request)`)。
   - 此时 `Used = min(Quota, Request)`。

2. **Second Pass - 分配剩余资源 (Over-Quota)**:
   - 集群剩余资源 = `Total - Sum(Deserved)`。
   - 这些资源根据队列的 `OverQuotaWeight` 进行加权分配。
   - **kValue 调节**: 算法引入了 `kValue` 参数来调节分配策略（平衡“按权重分配”与“按当前使用量惩罚”）。公式约为：`Weight = ConfigWeight + k * (ConfigWeight - CurrentUsage)`。

3. **Result**: 最终得到每个队列的 `FairShare`。

---

## 3. 队列排序逻辑 (Queue Ordering)

调度器在选择 Job 之前，先要选择 Queue。`Proportion` 插件实现了极其精细的队列比较逻辑 (`QueueOrderFn`)。

代码位置：`pkg/scheduler/plugins/proportion/queue_order/queue_order.go`

比较两个队列 `L` 和 `R` 时，依次执行以下策略（一旦分出胜负即返回）：

| 优先级 | 策略名称              | 逻辑描述                                                                      | 目的                                              |
| :----- | :-------------------- | :---------------------------------------------------------------------------- | :------------------------------------------------ |
| 1      | **UnderUtilized**     | 当前用量 < FairShare 的队列优先。                                             | **核心公平性**：没吃饱的先吃。                    |
| 2      | **UnderQuota**        | 当前用量 < Quota 的队列优先。                                                 | **保障性**：保障基本配额。                        |
| 3      | **Priority**          | `Queue.Priority` 高的优先。                                                   | **特权**：高优先级业务优先。                      |
| 4      | **PenalizeZeroShare** | 如果某资源类型的 AllocatableShare 为 0 却仍需申请，排后面。                   | 避免死锁或无效调度。                              |
| 5      | **SmallerDRF**        | **Dominant Resource Fairness (DRF)** 变种。计算“主导资源份额”，份额小的优先。 | **多维资源公平**：CPU型和内存型作业混合时的公平。 |
| 6      | **WeakestFirst**      | `AllocatableShare` 总量小的优先。                                             | 扶持弱小。                                        |
| 7      | **FIFO**              | 创建时间早的优先。                                                            | **Tie-Breaker**。                                 |

---

## 4. Reclaim与Preempt支持

Proportion 插件不仅决定“谁先吃”，还决定“谁吐出来”。

### 4.1 CanReclaimResourcesFn

- 判断一个队列是否应该发起 Reclaim。
- 只有当 `Usage < Deserved` (被饿死) 时，才有资格去抢别人的资源。

### 4.2 ReclaimableFn (Validator)

- 在计算由此产生的“受害者”方案时，验证该方案是否合理。
- 确保抢占后，受害者队列的资源不会低于其应有的底线，或者抢占者不会拿走超过其 `Deserved` 的量。

---

## 5. 关键配置参数

在 `scheduler-config.yaml` 中可以配置该插件：

```yaml
plugins:
  - name: proportion
    arguments:
      kValue: "1.0" # 调节权重敏感度
      relcaimerSaturationMultiplier: "1.1" # 允许 Reclaimer稍微这就一点（为了避免抖动）
```

---

## 6. 总结

Proportion 插件是 KAI Scheduler 与原生 K8s Scheduler 最大的区别之一：

- 原生 Scheduler 主要是 Pod 维度的打分（Bin-packing / Spreading）。
- Proportion 引入了 **Queue** 和 **Tenant** 的概念，在 Job 进场前实现了宏观的资源治理。

理解了 Proportion，就理解了多租户调度的核心。
